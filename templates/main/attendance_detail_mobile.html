{% extends "base.html" %}
{% block title %}Mark Attendance - {{ meeting_date }}{% endblock %}

{% block mobile_content %}
<!-- Mobile Attendance UI -->
<div class="mobile-attendance-container">
    <!-- Header Section -->
    <div class="attendance-header">
        <a href="{{ url_for('main.meeting_dates') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-content">
            <h1>Mark Attendance</h1>
            <p>Meeting Date: {{ meeting_date }}</p>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card present-card">
            <div class="summary-label">Present</div>
            <div class="summary-number" id="presentCount-mobile">0</div>
        </div>
        <div class="summary-card absent-card">
            <div class="summary-label">Absent</div>
            <div class="summary-number" id="absentCount-mobile">0</div>
        </div>
    </div>
    
    <!-- Global Action Buttons -->
    {% if can_mark_attendance %}
    <div class="global-actions">
        <button type="button" class="action-btn all-present-btn" onclick="markAllPresent()">
            <i class="fas fa-check-double"></i>
            All Present
        </button>
        <button type="button" class="action-btn all-absent-btn" onclick="markAllAbsent()">
            <i class="fas fa-times-circle"></i>
            All Absent
        </button>
    </div>
    {% endif %}
    
    <!-- Members List -->
    <div class="members-list-section">
        {% if members %}
            <form id="attendanceForm">
                <div class="members-list">
                    {% for member in members %}
                    <div class="member-item" data-member-id="{{ member.id }}">
                        <div class="member-info-section">
                            <div class="member-name">{{ member.name }}</div>
                            {% if member.id %}
                            <div class="member-id">{{ member.id[:8]|upper }}</div>
                            {% endif %}
                        </div>
                        <div class="member-action-icons">
                            <button type="button" 
                                    class="icon-btn present-icon-btn {% if attendance_data[member.id].present %}active{% endif %}"
                                    data-member-id="{{ member.id }}"
                                    onclick="{% if can_mark_attendance %}markMemberPresent('{{ member.id }}'){% else %}showAttendanceLockedMessage(){% endif %}"
                                    title="{% if can_mark_attendance %}Mark as Present{% else %}Attendance is locked{% endif %}"
                                    {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                <i class="fas fa-check-circle"></i>
                            </button>
                            <button type="button" 
                                    class="icon-btn absent-icon-btn {% if not attendance_data[member.id].present %}active{% endif %}"
                                    data-member-id="{{ member.id }}"
                                    onclick="{% if can_mark_attendance %}markMemberAbsent('{{ member.id }}'){% else %}showAttendanceLockedMessage(){% endif %}"
                                    title="{% if can_mark_attendance %}Mark as Absent{% else %}Attendance is locked{% endif %}"
                                    {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </div>
                        <input type="checkbox" 
                               class="member-checkbox" 
                               name="attendance" 
                               value="{{ member.id }}"
                               data-member-id="{{ member.id }}"
                               style="display: none;"
                               {% if attendance_data[member.id].present %}checked{% endif %}>
                    </div>
                    {% endfor %}
                </div>
            </form>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>No Members</h3>
                <p>No members found for this cell group</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Attendance Locked Warning -->
    {% if not can_mark_attendance %}
    <div class="submit-container">
        <div class="alert alert-warning" style="margin: 15px; padding: 15px; border-radius: 10px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-lock" style="font-size: 20px;"></i>
                <div>
                    <h6 style="margin: 0 0 5px 0; font-weight: 600;">Attendance Locked</h6>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">Attendance can only be marked until Wednesday. This week's attendance is now closed.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Submit Button -->
    {% if members and can_mark_attendance %}
    <div class="submit-container">
        <button type="button" class="submit-btn" onclick="submitAttendance()">
            <i class="fas fa-check-circle"></i>
            Submit
        </button>
    </div>
    {% endif %}
    
    <!-- Feedback Message -->
    <div id="feedbackMessage" class="feedback-message" style="display: none;"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeConfirmModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Attendance</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit the attendance for this meeting?</p>
                <div class="attendance-summary">
                    <div class="summary-item">
                        <span class="summary-label">Present:</span>
                        <span class="summary-value present-value" id="confirmPresentCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Absent:</span>
                        <span class="summary-value absent-value" id="confirmAbsentCount">0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel-btn" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="modal-btn confirm-btn" onclick="confirmSubmit()">
                    <i class="fas fa-check"></i>
                    Yes, Submit
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block mobile_nav %}
<a href="{{ url_for('main.index') }}" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Home</span>
</a>
<a href="{{ url_for('main.members') }}" class="nav-link">
    <i class="fas fa-users"></i>
    <span>Members</span>
</a>
<a href="{{ url_for('main.profile') }}" class="nav-link">
    <i class="fas fa-user"></i>
    <span>Profile</span>
</a>
<a href="{{ url_for('auth.logout') }}" class="nav-link">
    <i class="fas fa-sign-out-alt"></i>
    <span>Logout</span>
</a>
{% endblock %}

{% block extra_css %}
<style>
/* Mobile Attendance - Matching Requested Layout with Dark Theme */
* {
    -webkit-tap-highlight-color: transparent;
}

.mobile-attendance-container {
    background: #0f172a;
    min-height: 100vh;
    padding-bottom: 100px;
}

/* Header Section */
.attendance-header {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    padding: 1.5rem 1.25rem;
    border-bottom: 1px solid #475569;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.back-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.back-btn:active {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(0.95);
}

.header-content {
    flex: 1;
}

.header-content h1 {
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.25rem 0;
    line-height: 1.2;
}

.header-content p {
    color: #94a3b8;
    font-size: 0.9rem;
    margin: 0;
    font-weight: 500;
}

/* Summary Cards */
.summary-cards {
    display: flex;
    gap: 1rem;
    padding: 1.5rem 1.25rem;
    background: #0f172a;
}

.summary-card {
    flex: 1;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid #475569;
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.present-card {
    border-left: 4px solid #10b981;
}

.absent-card {
    border-left: 4px solid #ef4444;
}

.summary-label {
    color: #94a3b8;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.75rem;
}

.summary-number {
    color: white;
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
}

/* Global Action Buttons */
.global-actions {
    display: flex;
    gap: 1rem;
    padding: 0 1.25rem 1.5rem;
    background: #0f172a;
}

.action-btn {
    flex: 1;
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    min-height: 44px;
}

.all-present-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
}

.all-present-btn:active {
    transform: scale(0.98);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.all-absent-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}

.all-absent-btn:active {
    transform: scale(0.98);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.action-btn i {
    font-size: 0.95rem;
}

/* Members List Section */
.members-list-section {
    padding: 0 1.25rem;
    background: #0f172a;
}

.members-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.member-item {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid #475569;
    border-radius: 16px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.member-item:active {
    transform: scale(0.98);
}

.member-info-section {
    flex: 1;
    min-width: 0;
}

.member-name {
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    line-height: 1.3;
}

.member-id {
    color: #94a3b8;
    font-size: 0.85rem;
    font-weight: 500;
    font-family: 'Courier New', monospace;
}

/* Member Action Icons */
.member-action-icons {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
}

.icon-btn {
    width: 44px;
    height: 44px;
    border: 2px solid;
    border-radius: 12px;
    background: transparent;
    color: #94a3b8;
    font-size: 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    padding: 0;
}

.present-icon-btn {
    border-color: #64748b;
    color: #64748b;
}

.present-icon-btn:hover {
    border-color: #10b981;
    color: #10b981;
    background: rgba(16, 185, 129, 0.1);
}

.present-icon-btn.active {
    border-color: #10b981;
    color: #10b981;
    background: rgba(16, 185, 129, 0.15);
}

.present-icon-btn.active:hover {
    background: rgba(16, 185, 129, 0.25);
}

.absent-icon-btn {
    border-color: #64748b;
    color: #64748b;
}

.absent-icon-btn:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.absent-icon-btn.active {
    border-color: #ef4444;
    color: #ef4444;
    background: rgba(239, 68, 68, 0.15);
}

.absent-icon-btn.active:hover {
    background: rgba(239, 68, 68, 0.25);
}

.icon-btn:active {
    transform: scale(0.95);
}

/* Submit Container */
.submit-container {
    position: fixed;
    bottom: 70px;
    left: 0;
    right: 0;
    padding: 1rem 1.25rem;
    background: linear-gradient(to top, #0f172a 0%, #0f172a 80%, transparent 100%);
    z-index: 200;
}

.submit-btn {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border: none;
    border-radius: 14px;
    color: white;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    min-height: 48px;
}

.submit-btn:active {
    transform: scale(0.98);
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.submit-btn i {
    font-size: 1rem;
}

/* Feedback Message */
.feedback-message {
    position: fixed;
    bottom: 140px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 2px solid #475569;
    border-radius: 16px;
    padding: 1rem 1.5rem;
    color: white;
    font-size: 0.95rem;
    font-weight: 600;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    max-width: calc(100% - 2.5rem);
    text-align: center;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

.feedback-message.success {
    border-color: #10b981;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.25));
}

.feedback-message.error {
    border-color: #ef4444;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
}

/* Confirmation Modal */
.confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.modal-content {
    position: relative;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid #475569;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease;
    z-index: 1;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
    color: white;
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0;
}

.modal-body {
    padding: 1.5rem;
}

.modal-body p {
    color: #cbd5e1;
    font-size: 1rem;
    margin: 0 0 1.5rem 0;
    line-height: 1.5;
}

.attendance-summary {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.summary-label {
    color: #94a3b8;
    font-size: 0.95rem;
    font-weight: 500;
}

.summary-value {
    font-size: 1.1rem;
    font-weight: 700;
}

.present-value {
    color: #10b981;
}

.absent-value {
    color: #ef4444;
}

.modal-footer {
    padding: 1rem 1.5rem 1.5rem;
    display: flex;
    gap: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-btn {
    flex: 1;
    padding: 0.875rem 1.25rem;
    border: none;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    min-height: 44px;
}

.cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.cancel-btn:active {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(0.98);
}

.confirm-btn {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.confirm-btn:active {
    background: linear-gradient(135deg, #1d4ed8, #3b82f6);
    transform: scale(0.98);
}

.confirm-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 20px;
    border: 1px solid #475569;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #30363d, #21262d);
    color: #94a3b8;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    margin: 0 auto 1.5rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.empty-state h3 {
    color: #f0f6fc;
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.empty-state p {
    color: #94a3b8;
    font-size: 1rem;
    margin: 0;
}

/* Responsive Adjustments */
@media (max-width: 360px) {
    .attendance-header {
        padding: 1.25rem 1rem;
    }
    
    .header-content h1 {
        font-size: 1.3rem;
    }
    
    .summary-cards {
        padding: 1.25rem 1rem;
        gap: 0.75rem;
    }
    
    .summary-card {
        padding: 1.25rem;
    }
    
    .summary-number {
        font-size: 2rem;
    }
    
    .global-actions {
        padding: 0 1rem 1.25rem;
        gap: 0.75rem;
    }
    
    .action-btn {
        padding: 0.625rem 1rem;
        font-size: 0.85rem;
        min-height: 40px;
    }
    
    .members-list-section {
        padding: 0 1rem;
    }
    
    .member-item {
        padding: 1rem;
    }
    
    .member-name {
        font-size: 1rem;
    }
    
    .icon-btn {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
    }
    
    .member-action-icons {
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Make functions globally accessible
window.markMemberPresent = function(memberId) {
    try {
        const memberItem = document.querySelector(`[data-member-id="${memberId}"]`);
        if (!memberItem) {
            console.error('Member item not found for ID:', memberId);
            return;
        }
        
        const checkbox = memberItem.querySelector('.member-checkbox');
        const presentBtn = memberItem.querySelector('.present-icon-btn');
        const absentBtn = memberItem.querySelector('.absent-icon-btn');
        
        if (!checkbox || !presentBtn || !absentBtn) {
            console.error('Required elements not found for member:', memberId);
            return;
        }
        
        // Set checkbox to checked (present)
        checkbox.checked = true;
        
        // Update button states
        presentBtn.classList.add('active');
        absentBtn.classList.remove('active');
        
        updateCounts();
    } catch (error) {
        console.error('Error in markMemberPresent:', error);
    }
}

// Mark member as absent
window.markMemberAbsent = function(memberId) {
    try {
        const memberItem = document.querySelector(`[data-member-id="${memberId}"]`);
        if (!memberItem) {
            console.error('Member item not found for ID:', memberId);
            return;
        }
        
        const checkbox = memberItem.querySelector('.member-checkbox');
        const presentBtn = memberItem.querySelector('.present-icon-btn');
        const absentBtn = memberItem.querySelector('.absent-icon-btn');
        
        if (!checkbox || !presentBtn || !absentBtn) {
            console.error('Required elements not found for member:', memberId);
            return;
        }
        
        // Set checkbox to unchecked (absent)
        checkbox.checked = false;
        
        // Update button states
        presentBtn.classList.remove('active');
        absentBtn.classList.add('active');
        
        updateCounts();
    } catch (error) {
        console.error('Error in markMemberAbsent:', error);
    }
}

// Mark all present
window.markAllPresent = function() {
    const checkboxes = document.querySelectorAll('.member-checkbox');
    const presentButtons = document.querySelectorAll('.present-icon-btn');
    const absentButtons = document.querySelectorAll('.absent-icon-btn');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    
    presentButtons.forEach(btn => {
        btn.classList.add('active');
    });
    
    absentButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    updateCounts();
}

// Mark all absent
window.markAllAbsent = function() {
    const checkboxes = document.querySelectorAll('.member-checkbox');
    const presentButtons = document.querySelectorAll('.present-icon-btn');
    const absentButtons = document.querySelectorAll('.absent-icon-btn');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    presentButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    absentButtons.forEach(btn => {
        btn.classList.add('active');
    });
    
    updateCounts();
}

// Update counts
function updateCounts() {
    const checkedBoxes = document.querySelectorAll('.member-checkbox:checked');
    const presentCount = checkedBoxes.length;
    const totalMembers = document.querySelectorAll('.member-checkbox').length;
    const absentCount = totalMembers - presentCount;
    
    const presentCountEl = document.getElementById('presentCount-mobile');
    const absentCountEl = document.getElementById('absentCount-mobile');
    
    if (presentCountEl) presentCountEl.textContent = presentCount;
    if (absentCountEl) absentCountEl.textContent = absentCount;
}

// Show confirmation modal
window.submitAttendance = function() {
    {% if not can_mark_attendance %}
    showAttendanceLockedMessage();
    return;
    {% endif %}
    
    // Update modal summary
    const checkedBoxes = document.querySelectorAll('.member-checkbox:checked');
    const presentCount = checkedBoxes.length;
    const totalMembers = document.querySelectorAll('.member-checkbox').length;
    const absentCount = totalMembers - presentCount;
    
    document.getElementById('confirmPresentCount').textContent = presentCount;
    document.getElementById('confirmAbsentCount').textContent = absentCount;
    
    // Show modal
    const modal = document.getElementById('confirmModal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

// Close confirmation modal
window.closeConfirmModal = function() {
    const modal = document.getElementById('confirmModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Confirm and submit attendance
window.confirmSubmit = function() {
    try {
        const confirmBtn = document.querySelector('.confirm-btn');
        const memberCheckboxes = document.querySelectorAll('.member-checkbox');
        
        if (!confirmBtn) {
            console.error('Confirm button not found');
            return;
        }
        
        if (memberCheckboxes.length === 0) {
            showFeedback('No members found to submit', 'error');
            return;
        }
        
        // Disable confirm button
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Submitting...</span>';
        
        // Collect attendance data
        const attendance = [];
        memberCheckboxes.forEach(checkbox => {
            const memberId = checkbox.getAttribute('data-member-id');
            if (!memberId) {
                console.warn('Checkbox missing member ID');
                return;
            }
            const status = checkbox.checked ? 'present' : 'absent';
            attendance.push({
                member_id: memberId,
                status: status
            });
        });
        
        if (attendance.length === 0) {
            showFeedback('No attendance data to submit', 'error');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check"></i><span>Yes, Submit</span>';
            return;
        }
        
        console.log('Submitting attendance:', attendance);
        
        // Send to server
        const meetingDate = '{{ meeting_date }}';
        fetch(`/bulk_update_attendance/${encodeURIComponent(meetingDate)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ attendance: attendance })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Close modal
                closeConfirmModal();
                showFeedback(data.message, 'success');
                // Reload page after 1.5 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showFeedback(data.message || 'Error submitting attendance', 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check"></i><span>Yes, Submit</span>';
            }
        })
        .catch(error => {
            console.error('Error submitting attendance:', error);
            showFeedback(error.message || 'Network error. Please try again.', 'error');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check"></i><span>Yes, Submit</span>';
        });
    } catch (error) {
        console.error('Error in confirmSubmit:', error);
        showFeedback('An error occurred. Please try again.', 'error');
        const confirmBtn = document.querySelector('.confirm-btn');
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check"></i><span>Yes, Submit</span>';
        }
    }
}

// Show attendance locked message
window.showAttendanceLockedMessage = function() {
    showFeedback('Attendance can only be marked until Wednesday. This week\'s attendance is now closed.', 'error');
}

// Show feedback message
function showFeedback(message, type) {
    const feedbackEl = document.getElementById('feedbackMessage');
    if (feedbackEl) {
        feedbackEl.textContent = message;
        feedbackEl.className = `feedback-message ${type}`;
        feedbackEl.style.display = 'block';
        
        setTimeout(() => {
            feedbackEl.style.display = 'none';
        }, 3000);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCounts();
});
</script>
{% endblock %}
